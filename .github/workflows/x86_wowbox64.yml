name: x86-wowbox64

on:
  workflow_dispatch:
    inputs:
      channel:
        type: choice
        description: "auto=stable+nightly, stable=tag, nightly=HEAD"
        options: [auto, stable, nightly]
        default: auto
      host:
        type: boolean
        default: false
        description: "Self-hosted"
      version:
        type: string
        description: "Stable only: (e.g. 'v0.3.6, v0.3.8'). Empty = latest stable"

  schedule:
    - cron: "0 17 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  GH_TOKEN:        ${{ github.token }}
  UNI_KIND:        wowbox64
  REL_TAG_STABLE:  WOWBOX64
  REL_TAG_NIGHTLY: WOWBOX64-NIGHTLY
  UPSTREAM_REPO:   ptitSeb/box64

defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  guard:
    name: Build Guard
    runs-on: ${{ inputs.host == true && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 5
    env:
      IN_CHANNEL:  ${{ github.event_name == 'workflow_dispatch' && inputs.channel || 'stable' }}
      IN_VERSION:  ${{ github.event_name == 'workflow_dispatch' && inputs.version || '' }}
      IS_SCHEDULE: ${{ github.event_name == 'schedule' }}
    outputs:
      missing: ${{ steps.check.outputs.missing }}
      matrix:  ${{ steps.matrix.outputs.matrix }}
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check Upstream & Queue
        id: check
        run: |
          if [[ -n "${IN_VERSION:-}" ]]; then
            IN_VERSION="${IN_VERSION// /,}"
            export IN_VERSION
          fi

          bash ./scripts/guard.sh

      - name: Build matrix from queue
        id: matrix
        env:
          ROWS:    ${{ steps.check.outputs.list }}
          MISSING: ${{ steps.check.outputs.missing }}
        run: bash ./scripts/guard-matrix.sh

  build:
    name: Build ${{ format('{0} ({1})', matrix.rel_title, matrix.ver_name) }}
    needs: guard
    if: needs.guard.outputs.missing == 'true'
    runs-on: ${{ inputs.host == true && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.guard.outputs.matrix) }}
    env:
      REF:           ${{ matrix.ref }}
      FILENAME:      ${{ matrix.filename }}
      VER_NAME:      ${{ matrix.ver_name }}
      REL_TAG:       ${{ matrix.rel_tag }}
      REL_TITLE:     ${{ matrix.rel_title }}
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Deps
        run: bash ./scripts/install-deps-ubuntu.sh

      - name: Setup Build Env
        run: bash ./scripts/setup-llvm.sh

      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref:        ${{ env.REF }}
          submodules: recursive
          path: src
          fetch-depth: 1

      - name: Build
        env:
          PROFILE_SH: ./scripts/profiles/${{ env.UNI_KIND }}.sh
        run: |
          mkdir -p _logs artifacts

          {
            echo "::group::Building ${REF} (${VER_NAME})"

            # 1. Clean
            rm -rf build pkg

            # 2. Configure
            cmake -S src -B build -G Ninja \
              -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
              -DCMAKE_BUILD_TYPE=Release \
              -DARM_DYNAREC=1 \
              -DWOW64=1 \
              -DTERMUX=0 \
              -DHAVE_TRACE=0 \
              -DZYDIS3=1 \
              -DBOX32=0 \
              -DCI=0 \
              -DSTATICBUILD=0

            # 3. Build
            cmake --build build --target wowbox64 --parallel "$(nproc)"

            # 4. Find DLL
            DLL="$(find build -name 'wowbox64.dll' -type f | head -n1)"
            [[ -f "$DLL" ]] || { echo "::error::wowbox64.dll not found"; exit 1; }

            # 5. Verification
            llvm-readobj -h "$DLL" | grep -qE 'Machine:.*(ARM64|AARCH64)' || {
              echo "::error::Unexpected MACHINE for wowbox64.dll"
              llvm-readobj -h "$DLL" || true
              exit 1
            }

            mkdir -p pkg

            # 6. Pack WCP
            WCP_SINGLE_BIN_SOURCE="$DLL" \
            PROFILE_SH="$PROFILE_SH" \
            bash ./scripts/packing.sh \
              "-" \
              "-" \
              "pkg" \
              "${VER_NAME}" \
              "artifacts/${FILENAME}"

          } 2>&1 | tee "_logs/${UNI_KIND}-${VER_NAME}-build.log"

      - name: Process Logs
        if: always()
        run: bash ./scripts/log.sh _logs/*.log

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REL_TAG }}-${{ env.VER_NAME }}-logs
          path: _logs/

      - name: Release
        env:
          REPO:           ${{ github.repository }}
          ARTIFACT_GLOB:  "artifacts/${{ env.FILENAME }}"
          VERSION_PREFIX: "${{ env.UNI_KIND }}-"
          BODY: |
            - Architecture: ARM64 host (Linux ELF / Wine) + 32-bit x86 guest thunk
            - **Exclusive for Bionic**
        run: bash ./scripts/release.sh

  bump-readme:
    needs: build
    uses: ./.github/workflows/chore_purrrser.yml
    secrets: inherit
