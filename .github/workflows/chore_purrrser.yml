#  /\_/\
# (=â€¢á†½â€¢=)ã¥ðŸ”

name: chore-purrrser

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write

concurrency:
  group: purrrser-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  bump-readme:
    name: Update README
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest main
        run: |
          git fetch origin main
          git checkout main
          git reset --hard origin/main

      - name: Install tools
        run: |
          sudo apt-get -yqq update
          sudo apt-get -yqq install --no-install-recommends jq perl

      - name: Setup & Validate Map
        id: setup
        run: |
          # 1. Define Mapping
          cat > map.json <<'EOF'
          {
            "fex":      "FEXCore",
            "dxvk":     "DXVK",
            "sarek":    "DXVK-SAREK-ASYNC",
            "gplasync": "DXVK-GPLASYNC",
            "vkd3d":    "VKD3D-PROTON",
            "box64":    "BOX64-BIONIC"
          }
          EOF

          # 2. Validate README Placeholders
          echo "::group::Validating Placeholders"
          missing=0
          while read -r key; do
            count=$(grep -o "<!--${key}-->" README.md | wc -l | tr -d ' ')
            if [ "$count" -eq 0 ]; then
              echo "::error file=README.md::Placeholder <!--${key}--> not found"
              missing=1
            else
              echo "âœ… <!--${key}--> found (${count} occurrence(s))"
            fi
          done < <(jq -r 'keys[]' map.json)
          [ "$missing" -eq 0 ] || exit 1
          echo "::endgroup::"

      - name: Resolve Versions
        id: resolve
        run: |
          cp README.md README.before
          cp README.md README.tmp
          
          # Regex to capture version after "- Current version:"
          REGEX='^\s*-\s*Current\s+version:\s*([0-9]+(?:\.[0-9]+){0,2}[0-9A-Za-z]*(?:[-+][0-9A-Za-z().-]+)*)'

          echo "::group::Fetching Release Info"
          
          while IFS=$'\t' read -r key tag; do
            printf "%-10s : " "$key"

            ver_raw=""
            if body=$(gh release view "$tag" --repo "$REPO" --json body --jq '.body' 2>/dev/null); then
              ver_raw=$(echo "$body" | perl -ne "print \$1 if /$REGEX/m")
            fi

            if [ -z "$ver_raw" ]; then
              ver="â›”BRRR"
              echo "â›” failed to parse version, setting to $ver"
            else
              valid=1
              if [ "$tag" = "FEXCore" ]; then
                perl -e 'exit((shift)=~/^\d{2,6}(\.\d+)?$/ ? 0 : 1)' "$ver_raw" || valid=0
              else
                perl -e 'exit((shift)=~/^(?:\d+\.\d+\.\d+(?:[-+][\w().-]+)*|\d+\.\d+[0-9A-Za-z]*(?:\.\w+)*(?:[-+][\w().-]+)*|\d{4}[-.]\d{2}[-.]\d{2}|\d{8})$/ ? 0 : 1)' "$ver_raw" || valid=0
              fi

              if [ "$valid" -eq 0 ]; then
                ver="â›”BRRR"
                echo "â›” suspicious format '$ver_raw', setting to $ver"
              else
                ver="$ver_raw"
              fi
            fi

            # box64
            final_ver="$ver"
            if [ "$key" = "box64" ] && [ "$ver" != "â›”BRRR" ]; then
              base=$(echo "$ver" | perl -ne 'print "$1.$2.$3" if /^(\d+)\.(\d+)\.(\d+)/')
              if [ -n "$base" ]; then
                maj=${base%%.*}
                rest=${base#*.}
                min=${rest%%.*}
                pat=${rest#*.}
                next=$((pat+1))
                final_ver="${maj}.${min}.${pat} Â· ${maj}.${min}.${next}"
              fi
            fi

            perl -0777 -pe "s/(<!--${key}-->)(?:[^\\|\\n]*)?(?=\\s*\\|)/\\1 ${final_ver}/g" -i README.tmp

            echo "â†’ $final_ver"
          done < <(jq -r 'to_entries[] | "\(.key)\t\(.value)"' map.json)
          
          echo "::endgroup::"

          if cmp -s README.before README.tmp; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes in README."
            rm -f README.tmp
          else
            mv README.tmp README.md
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "README updated."
          fi

      - name: Apply & Push
        if: steps.resolve.outputs.changed == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "58444892+github-actions[bot]@users.noreply.github.com"

          git checkout main

          git add README.md
          if git diff --cached --quiet; then
            echo "No staged changes; skip commit."
            exit 0
          fi

          git commit -m "ci(readme): bump versions ðŸ˜»"
          git push origin main

