name: Box64-Glibc Nightly

on:
  workflow_dispatch:              # Manual trigger (any branch)
  schedule:
    - cron: "0 18 * * *"         # Weekly (UTC Sunday)

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Use strict, fast, and consistent shell across all steps (no cache anywhere)
defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  resolve-latest:
    name: Resolve upstream HEAD (commit)
    runs-on: ubuntu-latest
    outputs:
      sha:      ${{ steps.upstream.outputs.sha }}
      short:    ${{ steps.upstream.outputs.short }}
      datecode: ${{ steps.datecode.outputs.code }}
    steps:
      - name: Install tools (jq, curl)
        run: |
          sudo apt-get -yq update
          sudo apt-get -yq install --no-install-recommends jq curl ca-certificates

      - name: Resolve upstream Box64 HEAD SHA (robust)
        id: upstream
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          API="https://api.github.com"
          OWNER="ptitSeb"
          REPO="box64"
          auth=(-H "Authorization: Bearer ${GH_TOKEN}")
          ua=(-H "User-Agent: ${GITHUB_REPOSITORY:-box64-nightly-workflow}")
          ver=(-H "X-GitHub-Api-Version: 2022-11-28" -H "Accept: application/vnd.github+json")
          fetch() { curl -fsSL --retry 6 --retry-delay 2 --retry-all-errors "${auth[@]}" "${ua[@]}" "${ver[@]}" "$1"; }

          default_branch="$(fetch "$API/repos/$OWNER/$REPO" | jq -r .default_branch)"
          [[ -z "$default_branch" || "$default_branch" == "null" ]] && default_branch="main"

          sha="$(fetch "$API/repos/$OWNER/$REPO/commits/${default_branch}" | jq -r .sha)"
          [[ -z "$sha" || "$sha" == "null" ]] && { echo "::error::Failed to resolve upstream HEAD SHA"; exit 1; }

          short="$(printf '%s' "$sha" | cut -c1-7)"
          echo "sha=${sha}"     >> "$GITHUB_OUTPUT"
          echo "short=${short}" >> "$GITHUB_OUTPUT"
          echo "Upstream ${default_branch} @ ${short}"

      - name: Decide date code (YYMMDD, KST)   # Stable timezone anchor for versionCode
        id: datecode
        run: echo "code=$(TZ=Asia/Seoul date +%y%m%d)" >> "$GITHUB_OUTPUT"

  compile-box64:
    name: Build & append ${{ needs.resolve-latest.outputs.short }}
    needs: [resolve-latest]
    runs-on: ubuntu-24.04-arm   # NOTE: requires Arm64 hosted runner; keep as-is by design
    steps:
      # Fast guards â€” exit early if nothing new to publish
      - name: Skip if same upstream commit already released (API check)
        id: guard_commit
        env:
          GH_TOKEN: ${{ github.token }}
          REPO:     ${{ github.repository }}
          SHA:      ${{ needs.resolve-latest.outputs.sha }}
        run: |
          API="https://api.github.com/repos/${REPO}/releases/tags/BOX64-NIGHTLY"
          HTTP="$(curl -s -o /tmp/release.json -w '%{http_code}' \
                   -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "$API" || true)"
          if [ "$HTTP" = "200" ] && jq -e --arg S "$SHA" '.body | contains($S)' /tmp/release.json >/dev/null; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Same upstream commit already released; skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if same-date asset exists (avoid duplicates)
        id: dupe
        if: steps.guard_commit.outputs.skip != 'true'
        env:
          GH_TOKEN:  ${{ github.token }}
          REPO:      ${{ github.repository }}
          DATECODE:  ${{ needs.resolve-latest.outputs.datecode }}
        run: |
          API="https://api.github.com"
          FILENAME="box64-nightly-${DATECODE}.wcp"
          HTTP="$(curl -s -o /tmp/nightly.json -w '%{http_code}' \
                  -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" \
                  "$API/repos/${REPO}/releases/tags/BOX64-NIGHTLY" || true)"
          if [ "$HTTP" = "200" ] && jq -e --arg N "$FILENAME" 'any(.assets[]?; .name == $N)' /tmp/nightly.json >/dev/null; then
            echo "skip=true"  >> "$GITHUB_OUTPUT"
            echo "Found asset ${FILENAME}; skipping build."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install build tools (minimal, no cache)
        if: steps.guard_commit.outputs.skip != 'true' && steps.dupe.outputs.skip != 'true'
        run: |
          sudo apt-get -yq update
          sudo apt-get -yq install --no-install-recommends \
            git cmake ninja-build build-essential zstd file jq curl unzip ca-certificates gh binutils patchelf

      - name: Checkout upstream Box64 (exact commit)
        if: steps.guard_commit.outputs.skip != 'true' && steps.dupe.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: ptitSeb/box64
          ref: ${{ needs.resolve-latest.outputs.sha }}
          submodules: recursive
          path: src
          fetch-depth: 1

      - name: Configure & build (glibc, Ninja, Release)
        if: steps.guard_commit.outputs.skip != 'true' && steps.dupe.outputs.skip != 'true'
        run: |
          cmake -S src -B src/build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build src/build -j"$(nproc)"

      - name: Strip binary (remove unneeded symbols; no perf impact)
        if: steps.guard_commit.outputs.skip != 'true' && steps.dupe.outputs.skip != 'true'
        run: |
          BIN="src/build/box64"
          [[ -f "$BIN" ]] || { echo "::error::Missing binary: $BIN"; exit 1; }
          if command -v llvm-strip >/dev/null 2>&1; then
            llvm-strip --strip-unneeded "$BIN"
          else
            strip --strip-unneeded "$BIN"
          fi
          file "$BIN"

      - name: Package WCP (commit-agnostic name; date-based versionCode)
        if: steps.guard_commit.outputs.skip != 'true' && steps.dupe.outputs.skip != 'true'
        env:
          DATECODE: ${{ needs.resolve-latest.outputs.datecode }}
        run: |
          VER="${DATECODE}"
          DESC="Version ${VER} Box64 build by Ari"

          mkdir -p Box64_WCP artifacts
          install -m 0755 src/build/box64 Box64_WCP/box64

          patchelf --set-interpreter /data/data/com.winlator/files/imagefs/usr/lib/ld-linux-aarch64.so.1 Box64_WCP/box64

          cat > Box64_WCP/profile.json <<JSON
          {
            "type": "Box64",
            "versionName": "nightly",
            "versionCode": ${VER},
            "description": "${DESC}",
            "files": [
              { "source": "box64", "target": "\${localbin}/box64" }
            ]
          }
          JSON

          (cd Box64_WCP && tar --zstd -cf "../artifacts/box64-nightly-${VER}.wcp" profile.json box64)

      - name: Ensure/Update release (BOX64-NIGHTLY) and upload asset
        if: steps.guard_commit.outputs.skip != 'true' && steps.dupe.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO:     ${{ github.repository }}
          SHORT:    ${{ needs.resolve-latest.outputs.short }}
          SHA:      ${{ needs.resolve-latest.outputs.sha }}
          DATECODE: ${{ needs.resolve-latest.outputs.datecode }}
        run: |
          BODY=$'ðŸŒ™ Automated BOX64 Glibc nightly builds (rolling)\n\nCommit: ['"${SHORT}"'](https://github.com/ptitSeb/box64/commit/'"${SHA}"')'
          if ! gh release view "BOX64-NIGHTLY" --repo "$REPO" >/dev/null 2>&1; then
            gh release create "BOX64-NIGHTLY" --repo "$REPO" -t "BOX64-NIGHTLY" -n "${BODY}"
          else
            gh release edit   "BOX64-NIGHTLY" --repo "$REPO" -t "BOX64-NIGHTLY" -n "${BODY}"
          fi

          gh release upload "BOX64-NIGHTLY" \
            "./artifacts/box64-nightly-${DATECODE}.wcp" \
            --repo "$REPO" --clobber

      - name: Trim old assets (keep latest 5)
        if: steps.guard_commit.outputs.skip != 'true' && steps.dupe.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          API="https://api.github.com/repos/${REPO}/releases/tags/BOX64-NIGHTLY"
          assets="$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$API" | jq -c '.assets | sort_by(.created_at)')"
          count="$(echo "$assets" | jq 'length')"
          if [ "$count" -gt 5 ]; then
            delcount=$((count-5))
            echo "::notice::Found $count assets, will delete $delcount oldest."
            echo "$assets" | jq -r ".[0:$delcount][] | .id" | while read -r id; do
              curl -s -X DELETE -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                   "https://api.github.com/repos/${REPO}/releases/assets/${id}"
              echo "Deleted asset id=$id"
            done
          else
            echo "::notice::Asset count $count (â‰¤5); nothing to delete."
          fi
